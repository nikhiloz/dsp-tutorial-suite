name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake valgrind lcov
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake lcov
    
    - name: Configure (Debug build)
      run: |
        mkdir -p build_debug
        cd build_debug
        cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON ..
    
    - name: Build (Debug)
      run: |
        cd build_debug
        make -j$(nproc || sysctl -n hw.ncpu)
    
    - name: Run tests
      run: |
        cd build_debug
        ctest --output-on-failure -V
    
    - name: Memory check with valgrind (Linux only)
      if: runner.os == 'Linux'
      run: |
        cd build_debug
        valgrind --leak-check=full --error-exitcode=1 ./bin/test_fft
        valgrind --leak-check=full --error-exitcode=1 ./bin/test_filter
    
    - name: Generate coverage (Linux only)
      if: runner.os == 'Linux'
      run: |
        cd build_debug
        lcov --directory . --capture --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        genhtml coverage.info --output-directory coverage_html
    
    - name: Upload coverage to Codecov
      if: runner.os == 'Linux' && matrix.compiler == 'gcc'
      uses: codecov/codecov-action@v3
      with:
        files: ./build_debug/coverage.info
        fail_ci_if_error: false
    
    - name: Configure (Release build)
      run: |
        mkdir -p build_release
        cd build_release
        cmake -DCMAKE_BUILD_TYPE=Release ..
    
    - name: Build (Release)
      run: |
        cd build_release
        make -j$(nproc || sysctl -n hw.ncpu)
    
    - name: Run executables
      run: |
        cd build_release
        ./bin/fft_demo
        ./bin/filter_demo

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install clang-format
      run: sudo apt-get install -y clang-format
    
    - name: Check code formatting
      run: |
        clang-format --dry-run -Werror src/*.c include/*.h examples/*.c tests/test_*.c
    
    - name: Static analysis with clang-tidy
      run: |
        sudo apt-get install -y clang-tidy
        clang-tidy src/*.c include/*.h -checks=bugprone-*,clang-analyzer-* -- -Iinclude
